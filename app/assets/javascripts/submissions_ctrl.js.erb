(function () {
  "use strict";

  angular.module("app").controller("submissionsCtrl", function($scope, $http, Upload) {

  $scope.setup = function(id, student_id) {
    $scope.id = id;
    $http.get('/api/v1/submissions?id='+id+'&student_id='+student_id).then(function(response) {
      $scope.submissions = response.data;
      if($scope.submissions.length > 0) {
        $scope.lastSubmission = $scope.submissions[$scope.submissions.length - 1];
        $scope.submissionText = $scope.lastSubmission.answer;
        $scope.getComments();
      } else {

      }
    }, function(response) {

    });
  }

  $scope.files = [];

  $scope.uploadFiles = function (files) {
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      $scope.upload = Upload.upload({
        url: '/api/v1/submissions',
        method: 'POST',
        fields: {'id': $scope.id},
        file: file,
        fileFormDataName: 'submission[solution]'
      });     
      $scope.files.push(file);
    }
  }

  $scope.getComments = function() {
    $scope.comments = [];
    for (var i = 0; i < $scope.submissions.length; i++) {
      if ($scope.submissions[i].comments[0] != null) {
        for (var j = 0; j < $scope.submissions[i].comments.length; j++) {
          $scope.comments.push($scope.submissions[i].comments[j]);
        };
      }; 
    }
  }

  $scope.submitText = function(text) {
    $http.post('/api/v1/submissions?id='+$scope.id, {'submission_text': text}).then(function(response) {
      $scope.lastSubmission = {};
      $scope.lastSubmission.answer = text;
      $scope.submissionText = text;
    }, function(response) {

    });

  }

  $scope.submitCommentText = function(text) {
    var comment = {
      'comment_text': text,
      'submission_id': $scope.lastSubmission.id
    };
    $http.post('/api/v1/comments', comment).then(function(response) {
      var comment = response.data;
      $scope.comments.push(comment);
    }, function(response) {
    });
  }

  window.scope = $scope;

});
})();